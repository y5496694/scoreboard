<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì€í•™êµ E-í˜ìŠ¤í‹°ë²Œ ì ìˆ˜íŒ</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Noto Sans KR í°íŠ¸ ë¡œë“œ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 
      Firebase SDK (v9 "compat")
      These scripts provide the global 'firebase' object.
    -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Noto Sans KR í°íŠ¸ ì ìš© */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* ìˆœìœ„ ì¹´ë“œ ì˜ì—­ ì¶•ì†Œ ë° ê¸€ë¡œìš° íš¨ê³¼ */
        #ranking-section {
            transform-origin: top center;
        }
        @media (min-width: 768px) {
            #ranking-section {
                width: 50%;
                margin-left: auto;
                margin-right: auto;
                transform: scale(0.85);
            }
        }
        @media (max-width: 767px) {
            #ranking-section {
                transform: scale(0.9);
            }
        }

        #rank-1 {
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); /* 1ë“± ê¸ˆìƒ‰ */
        }
        #rank-2 {
            box-shadow: 0 0 20px rgba(156, 163, 175, 0.8); /* 2ë“± ì€ìƒ‰ */
        }
        #rank-3 {
            box-shadow: 0 0 15px rgba(209, 139, 71, 0.8); /* 3ë“± ë™ìƒ‰ */
        }

        /* í•™ê¸‰ ì¶”ê°€ ì‹œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
        .class-entry {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ìˆ«ì ì…ë ¥ í•„ë“œì˜ ìŠ¤í”¼ë„ˆ(ì¦ê° ë²„íŠ¼) ìˆ¨ê¸°ê¸° */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ì‚­ì œ íŒì—…(ëª¨ë‹¬) ìŠ¤íƒ€ì¼ */
        #delete-modal-bg {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Flexboxë¡œ ì¤‘ì•™ ì •ë ¬ */
            /* 'display: none'ì´ ê¸°ë³¸ê°’ì´ë¯€ë¡œ flex ì†ì„±ì€ showModalì—ì„œ ì œì–´ */
            justify-content: center;
            align-items: center;
        }
        #delete-modal {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen">

    <!-- ê´€ë¦¬ì ì„¤ì • ë²„íŠ¼ (í†±ë‹ˆë°”í€´) -->
    <button id="open-admin-settings" class="absolute top-4 right-4 md:top-8 md:right-8 text-gray-600 hover:text-blue-700 transition-colors duration-200 z-10" title="ê´€ë¦¬ì ì„¤ì •">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- ì•± íƒ€ì´í‹€ -->
        <header class="text-center mb-8">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-blue-800">
                ì´ì€í•™êµ E-í˜ìŠ¤í‹°ë²Œ í•™ê¸‰ ì ìˆ˜íŒ
            </h1>
            <p id="main-subtitle" class="text-lg text-gray-600 mt-2">ì ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ìˆœìœ„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</p>
        </header>

        <!-- ì‹¤ì‹œê°„ ìˆœìœ„ ì„¹ì…˜ -->
        <section id="ranking-section" class="mb-8 p-4 bg-white/70 backdrop-blur-md rounded-2xl shadow-lg">
            <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„ ğŸ†</h2>
            <div class="flex flex-col md:flex-row justify-around gap-4">

                <!-- 2ë“± (Silver) -->
                <div id="rank-2" class="flex-1 p-4 bg-gradient-to-br from-gray-300 to-gray-400 text-white rounded-xl text-center transition-all duration-300 transform md:mt-2">
                    <span class="text-3xl block mb-2">ğŸ¥ˆ</span>
                    <span class="text-lg font-bold">2ë“±</span>
                    <div class="mt-2 text-base font-semibold" id="rank-2-class">---</div>
                    <div class="text-xl font-bold" id="rank-2-score">0ì </div>
                </div>

                <!-- 1ë“± (Gold) -->
                <div id="rank-1" class="flex-1 p-5 bg-gradient-to-br from-yellow-400 to-amber-500 text-white rounded-2xl text-center transition-all duration-300 transform md:-translate-y-2">
                    <span class="text-4xl block mb-2">ğŸ¥‡</span>
                    <span class="text-xl font-bold">1ë“±</span>
                    <div class="mt-2 text-lg font-semibold" id="rank-1-class">---</div>
                    <div class="text-2xl font-bold" id="rank-1-score">0ì </div>
                </div>

                <!-- 3ë“± (Bronze) -->
                <div id="rank-3" class="flex-1 p-4 bg-gradient-to-br from-yellow-600 to-orange-700 text-white rounded-xl text-center transition-all duration-300 transform md:mt-2">
                    <span class="text-3xl block mb-2">ğŸ¥‰</span>
                    <span class="text-lg font-bold">3ë“±</span>
                    <div class="mt-2 text-base font-semibold" id="rank-3-class">---</div>
                    <div class="text-xl font-bold" id="rank-3-score">0ì </div>
                </div>

            </div>
        </section>

        <!-- í•™ë…„ë³„ ì ìˆ˜íŒ ê·¸ë¦¬ë“œ (1ì—´ë¡œ ë³€ê²½) -->
        <main id="grade-container" class="grid grid-cols-1 gap-4">
            <!-- í•™ë…„ë³„ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
        </main>

    </div>

    <!-- ìˆ˜ì • í™•ì¸ ëª¨ë‹¬ -->
    <div id="edit-modal-bg" class="flex justify-center items-center" style="display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div id="edit-modal" class="bg-white p-6 rounded-lg shadow-xl" style="width: 90%; max-width: 400px;">
            <h4 class="text-xl font-bold mb-4">í•™ê¸‰ ìˆ˜ì •</h4>
            <label for="edit-name-input" class="block text-sm font-medium text-gray-700">ìƒˆ í•™ê¸‰ ì´ë¦„</label>
            <input type="text" id="edit-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ìƒˆ í•™ê¸‰ ì´ë¦„ ì…ë ¥">
            
            <div class="flex justify-between space-x-3 mt-5">
                <!-- ì‚­ì œ ë²„íŠ¼ (ì™¼ìª½) -->
                <button id="trigger-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200">
                    ì‚­ì œ
                </button>
                
                <!-- ì·¨ì†Œ ë° í™•ì¸ ë²„íŠ¼ (ì˜¤ë¥¸ìª½) -->
                <div class="flex space-x-3">
                    <button id="cancel-edit" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                        ì·¨ì†Œ
                    </button>
                    <button id="confirm-edit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="delete-modal-bg" class="flex justify-center items-center">
        <div id="delete-modal" class="bg-white p-6 rounded-lg shadow-xl" style="width: 90%; max-width: 400px;">
            <h4 class="text-xl font-bold mb-4">í•™ê¸‰ ì‚­ì œ</h4>
            <p class="text-gray-600 mb-3">ì‚­ì œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="password-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸ 20230301">
            <span id="modal-error" class="text-red-500 text-sm mt-1 h-4 block"></span>
            
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                    ì·¨ì†Œ
                </button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>


    <!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="admin-pass-modal-bg" class="flex justify-center items-center" style="display: none; position: fixed; z-index: 60; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div id="admin-pass-modal" class="bg-white p-6 rounded-lg shadow-xl" style="width: 90%; max-width: 400px;">
            <h4 class="text-xl font-bold mb-4">ê´€ë¦¬ì ì¸ì¦</h4>
            <p class="text-gray-600 mb-3">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="admin-password-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <span id="admin-pass-error" class="text-red-500 text-sm mt-1 h-4 block"></span>
            
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-admin-pass" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                    ì·¨ì†Œ
                </button>
                <button id="confirm-admin-pass" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ì„¤ì • ëª¨ë‹¬ (ì œëª© ìˆ˜ì • ë“±) -->
    <div id="admin-settings-modal-bg" class="flex justify-center items-center" style="display: none; position: fixed; z-index: 70; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div id="admin-settings-modal" class="bg-white p-6 rounded-lg shadow-xl" style="width: 90%; max-width: 500px;">
            <h4 class="text-xl font-bold mb-6">ê´€ë¦¬ì ì„¤ì •</h4>
            
            <div class="space-y-4">
                <div>
                    <label for="title-input" class="block text-sm font-medium text-gray-700">ì œëª©</label>
                    <input type="text" id="title-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none">
                </div>
                <div>
                    <label for="subtitle-input" class="block text-sm font-medium text-gray-700">ì„¤ëª…</label>
                    <input type="text" id="subtitle-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none">
                </div>
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-sm font-semibold text-gray-800 mb-2">ì„±ì¥ ë‹¨ê³„ ì ìˆ˜ ê¸°ì¤€</p>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <label class="flex items-center space-x-2">
                            <span class="w-16 text-gray-700">ì”¨ì•—</span>
                            <input type="number" id="threshold-seed" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" step="1">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="w-16 text-gray-700">ìƒˆì‹¹</span>
                            <input type="number" id="threshold-sprout" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" step="1">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="w-16 text-gray-700">ì¤„ê¸°</span>
                            <input type="number" id="threshold-stem" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" step="1">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="w-16 text-gray-700">ë‚˜ë¬´</span>
                            <input type="number" id="threshold-tree" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" step="1">
                        </label>
                        <label class="flex items-center space-x-2 col-span-2">
                            <span class="w-16 text-gray-700">ê½ƒ</span>
                            <input type="number" id="threshold-flower" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" step="1">
                        </label>
                        <p class="col-span-2 text-xs text-gray-500">* ì”¨ì•— ê¸°ì¤€ì€ í•­ìƒ 0ì ì´ë©°, ê° ë‹¨ê³„ëŠ” ê·¸ ì´í•˜ ë‹¨ê³„ì™€ ê°™ê±°ë‚˜ ë†’ì€ ê°’ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-admin-settings" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                    ì·¨ì†Œ
                </button>
                <button id="save-admin-settings" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200">
                    ì €ì¥
                </button>
            </div>
        </div>
    </div>


    <!-- 
      *** ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸ (GitHub ì—…ë¡œë“œìš©) ***
      - ì›ë˜ ì œê³µí•´ì£¼ì‹  firebaseConfigë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - signInAnonymously() (ìµëª… ë¡œê·¸ì¸)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - Firestore ê²½ë¡œë¥¼ "classes" ë° "settings"ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - 'ê¶Œí•œ ì˜¤ë¥˜' ìˆ˜ì •ì„ ìœ„í•´, ëª¨ë“  Firestore ì‘ì—…(onSnapshot)ì´
        ë°˜ë“œì‹œ ìµëª… ë¡œê·¸ì¸(await auth.signInAnonymously()) *ì´í›„*ì—
        ì‹¤í–‰ë˜ë„ë¡ async/await êµ¬ì¡°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
    -->
    <script>
        // --- 1. Your Firebase Configuration ---
        // GitHub ì—…ë¡œë“œìš©: ì›ë˜ ì œê³µí•´ì£¼ì‹  ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "AIzaSyB6G99nhN9cTPYp_Va_L3Jyg1ZudzownPE",
            authDomain: "scoreboard-92a21.firebaseapp.com",
            projectId: "scoreboard-92a21",
            storageBucket: "scoreboard-92a21.firebasestorage.app",
            messagingSenderId: "1016713769386",
            appId: "1:1016713769386:web:fc331ff8e301b07c2ebbd3",
            measurementId: "G-EWX63T6EGZ"
        };

        // --- 2. Initialize Firebase ---
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ë””ë²„ê¹…ì„ ìœ„í•´ Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì • (GitHub ì—…ë¡œë“œ ì‹œ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì œê±°í•´ë„ ë©ë‹ˆë‹¤)
        firebase.firestore.setLogLevel('debug');


        // --- 3. Application Global Variables ---
        let classToDelete = null;
        let classToEdit = null;
        const defaultThresholds = { seed: 0, sprout: 10, stem: 20, tree: 30, flower: 40 };
        let growthThresholds = { ...defaultThresholds };
        const grades = [
            { id: 'kinder', name: 'ìœ ì¹˜ì›', placeholder: 'ì˜ˆ: í–‡ë‹˜ë°˜' },
            { id: 'elem1', name: 'ì´ˆë“± 1í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' },
            { id: 'elem2', name: 'ì´ˆë“± 2í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' },
            { id: 'elem3', name: 'ì´ˆë“± 3í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' },
            { id: 'elem4', name: 'ì´ˆë“± 4í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' },
            { id: 'elem5', name: 'ì´ˆë“± 5í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' },
            { id: 'elem6', name: 'ì´ˆë“± 6í•™ë…„', placeholder: 'ì˜ˆ: 1ë°˜' }
        ];

        // --- 4. Page Load Event (Async) ---
        // window.onloadë¥¼ async í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ ì¸ì¦ì„ ë¨¼ì € ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
        window.onload = async function() {
            let userId;

            // --- 4a. Authentication (CRITICAL FIRST STEP) ---
            // 'ê¶Œí•œ ì—†ìŒ' ì˜¤ë¥˜ ë°©ì§€: ì¿¼ë¦¬ ì „ì— ë°˜ë“œì‹œ ìµëª… ë¡œê·¸ì¸ì„ ì™„ë£Œí•©ë‹ˆë‹¤.
            try {
                await auth.signInAnonymously();
                
                userId = auth.currentUser ? auth.currentUser.uid : crypto.randomUUID();
                console.log("Firebase Anonymous Authentication successful, UserID:", userId);

            } catch (error) {
                console.error("Firebase Authentication Failed:", error);
                document.body.innerHTML = `<h1 style='color: red; text-align: center; margin-top: 50px;'>ì¸ì¦ ì‹¤íŒ¨: ì•±ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>`;
                return; // ì¸ì¦ì— ì‹¤íŒ¨í•˜ë©´ ì•± ì‹¤í–‰ ì¤‘ë‹¨
            }

            // --- 4b. Setup Grade Cards (HTML) ---
            const container = document.getElementById('grade-container');
            grades.forEach(grade => {
                const card = document.createElement('div');
                card.className = 'grade-card bg-white p-4 rounded-2xl shadow-md flex flex-col space-y-3';
                card.innerHTML = `
                    <header class="flex justify-between items-center border-b border-blue-200 pb-2">
                        <h3 class="text-lg font-bold text-blue-700">${grade.name}</h3>
                        <button
                            onclick="addClass('${grade.id}')"
                            class="add-class-header-button bg-blue-500 text-white px-3 py-1 rounded-lg text-xs font-semibold hover:bg-blue-600 transition-all duration-200 flex items-center space-x-1"
                            title="í•™ê¸‰ ì¶”ê°€">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            <span>ì¶”ê°€</span>
                        </button>
                    </header>
                    <div id="class-list-${grade.id}" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 flex-grow">
                    </div>
                `;
                container.appendChild(card);
            });

            // --- 4c. Attach Firestore Listeners (NOW IT'S SAFE) ---
            // ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì œ Snapshot ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì…ë‹ˆë‹¤.
            // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("classes") ì‚¬ìš© ***
            db.collection("classes").onSnapshot((querySnapshot) => {
                // ê¸°ì¡´ í•™ê¸‰ ëª©ë¡ ì´ˆê¸°í™”
                document.querySelectorAll("[id^=class-list-]").forEach(list => list.innerHTML = '');

                querySnapshot.forEach((doc) => {
                    const classData = doc.data();
                    const classId = doc.id;
                    const listContainer = document.getElementById(`class-list-${classData.gradeId}`);
                    if (listContainer) {
                        const classEntry = document.createElement('div');
                        classEntry.className = 'class-entry bg-gray-50 rounded-xl border p-3 shadow-inner flex flex-col justify-between';
                        classEntry.setAttribute('data-id', classId);

                        const emoji = getGrowthEmoji(classData.score);
                        classEntry.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <span class="class-name text-lg font-bold text-gray-800">${classData.name}</span>
                                <button onclick="openEditModal(this)" class="flex-shrink-0 text-gray-500 hover:text-blue-600 transition-colors duration-200 p-1 rounded-full hover:bg-blue-100" title="í•™ê¸‰ ìˆ˜ì •">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center justify-center space-x-3 my-2">
                                <span class="class-emoji text-2xl">${emoji}</span>
                                <span class="class-score text-2xl font-bold text-blue-700">${classData.score}ì </span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-2">
                                <button onclick="addScore(this, 1)" class="px-3 py-2 bg-green-500 text-white rounded-lg text-xs font-semibold hover:bg-green-600 transition-all duration-200" title="ë¯¸ì…˜ ì‹œë„ +1ì ">+1</button>
                                <button onclick="addScore(this, 5)" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition-all duration-200" title="ë¯¸ì…˜ ì„±ê³µ +5ì ">+5</button>
                                <button onclick="addScore(this, 10)" class="px-3 py-2 bg-yellow-500 text-white rounded-lg text-xs font-semibold hover:bg-yellow-600 transition-all duration-200" title="ëª¨ë“  ë¯¸ì…˜ ì„±ê³µ +10ì ">+10</button>
                                <button onclick="addScore(this, -1)" class="px-3 py-2 bg-gray-400 text-white rounded-lg text-xs font-semibold hover:bg-gray-500 transition-all duration-200" title="ì ìˆ˜ ì°¨ê° -1ì ">-1</button>
                                <button onclick="addScore(this, -5)" class="px-3 py-2 bg-gray-400 text-white rounded-lg text-xs font-semibold hover:bg-gray-500 transition-all duration-200" title="ì ìˆ˜ ì°¨ê° -5ì ">-5</button>
                                <button onclick="addScore(this, -10)" class="px-3 py-2 bg-gray-400 text-white rounded-lg text-xs font-semibold hover:bg-gray-500 transition-all duration-200" title="ì ìˆ˜ ì°¨ê° -10ì ">-10</button>
                            </div>
                        `;
                        listContainer.appendChild(classEntry);
                    }
                });
                updateRankings();
            }, (error) => {
                console.error("Snapshot error on 'classes' collection:", error);
            });

            // ì„¤ì • ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
            // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("settings") ì‚¬ìš© ***
            db.collection("settings").doc("main").onSnapshot((doc) => {
                if (doc.exists) {
                    const settings = doc.data();
                    document.getElementById('main-title').textContent = settings.title || 'ì´ì€í•™êµ E-í˜ìŠ¤í‹°ë²Œ í•™ê¸‰ ì ìˆ˜íŒ';
                    document.getElementById('main-subtitle').textContent = settings.subtitle || 'ì ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ìˆœìœ„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.';
                    growthThresholds = sanitizeThresholds(settings.thresholds || {});
                    populateThresholdInputs();
                    applyGrowthEmojis();
                }
            }, (error) => {
                console.error("Snapshot error on 'settings' document:", error);
            });

            // --- 4d. Setup Modal Event Listeners ---
            document.getElementById('cancel-delete').onclick = hideModal;
            document.getElementById('confirm-delete').onclick = confirmDelete;
            document.getElementById('delete-modal-bg').onclick = (e) => { if (e.target === e.currentTarget) hideModal(); };
            document.getElementById('password-input').onkeydown = (e) => { if (e.key === 'Enter') confirmDelete(); };

            document.getElementById('cancel-edit').onclick = hideEditModal;
            document.getElementById('confirm-edit').onclick = confirmEdit;
            document.getElementById('trigger-delete').onclick = triggerDeleteFromEdit;
            document.getElementById('edit-modal-bg').onclick = (e) => { if (e.target === e.currentTarget) hideEditModal(); };
            document.getElementById('edit-name-input').onkeydown = (e) => { if (e.key === 'Enter') confirmEdit(); };

            document.getElementById('open-admin-settings').onclick = openAdminPassModal;
            document.getElementById('cancel-admin-pass').onclick = hideAdminPassModal;
            document.getElementById('confirm-admin-pass').onclick = checkAdminPassword;
            document.getElementById('admin-pass-modal-bg').onclick = (e) => { if (e.target === e.currentTarget) hideAdminPassModal(); };
            document.getElementById('admin-password-input').onkeydown = (e) => { if (e.key === 'Enter') checkAdminPassword(); };

            document.getElementById('cancel-admin-settings').onclick = hideAdminSettingsModal;
            document.getElementById('save-admin-settings').onclick = saveAdminSettings;
            document.getElementById('admin-settings-modal-bg').onclick = (e) => { if (e.target === e.currentTarget) hideAdminSettingsModal(); };
        };

        // --- 5. Application Functions ---
        // (ëª¨ë“  í•¨ìˆ˜ë“¤ì´ ì˜¬ë°”ë¥¸ DB ê²½ë¡œë¥¼ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •)

        function getGrowthEmoji(score) {
            const { sprout, stem, tree, flower } = growthThresholds;

            if (score >= flower) return 'ğŸŒ¸';
            if (score >= tree) return 'ğŸŒ³';
            if (score >= stem) return 'ğŸŒ¿';
            if (score >= sprout) return 'ğŸŒ±';
            return 'ğŸŒ°';
        }

        function sanitizeThresholds(rawThresholds) {
            const sanitized = { ...defaultThresholds, ...rawThresholds };
            sanitized.seed = 0;
            sanitized.sprout = Math.max(sanitized.seed, Number(sanitized.sprout) || 0);
            sanitized.stem = Math.max(sanitized.sprout, Number(sanitized.stem) || sanitized.sprout);
            sanitized.tree = Math.max(sanitized.stem, Number(sanitized.tree) || sanitized.stem);
            sanitized.flower = Math.max(sanitized.tree, Number(sanitized.flower) || sanitized.tree);
            return sanitized;
        }

        function populateThresholdInputs() {
            document.getElementById('threshold-seed').value = growthThresholds.seed;
            document.getElementById('threshold-sprout').value = growthThresholds.sprout;
            document.getElementById('threshold-stem').value = growthThresholds.stem;
            document.getElementById('threshold-tree').value = growthThresholds.tree;
            document.getElementById('threshold-flower').value = growthThresholds.flower;
        }

        function applyGrowthEmojis() {
            document.querySelectorAll('.class-entry').forEach(entry => {
                const scoreElement = entry.querySelector('.class-score');
                const emojiElement = entry.querySelector('.class-emoji');
                const score = parseInt(scoreElement.textContent) || 0;
                emojiElement.textContent = getGrowthEmoji(score);
            });
        }

        // í•™ê¸‰ ì¶”ê°€ í•¨ìˆ˜
        function addClass(gradeId) {
            const listContainer = document.getElementById(`class-list-${gradeId}`);
            const classCount = listContainer.querySelectorAll('.class-entry').length;
            
            const gradeInfo = grades.find(g => g.id === gradeId);
            let newClassName = `${classCount + 1}ë°˜`; 
            if (gradeInfo && gradeInfo.placeholder.includes('ë°˜')) {
                let placeholderName = gradeInfo.placeholder.split(' ').pop(); 
                let baseName = placeholderName.replace('ë°˜', ''); 
                let baseNumber = parseInt(baseName);
                if (!isNaN(baseNumber)) {
                    newClassName = `${baseNumber + classCount}ë°˜`;
                } else {
                    newClassName = `${baseName} ${classCount + 1}`;
                }
            } else if (gradeInfo) {
                let baseName = gradeInfo.placeholder.split(' ').pop();
                newClassName = `${baseName} ${classCount + 1}`;
            }
            
             if (gradeId.includes('kinder')) {
                 newClassName = `${classCount + 1}ë°˜`;
             }

            // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("classes") ì‚¬ìš© ***
            db.collection("classes").add({
                gradeId: gradeId,
                name: newClassName,
                score: 0
            });
        }

        // ì ìˆ˜ ì¶”ê°€/ì°¨ê° í•¨ìˆ˜
        function addScore(buttonElement, pointsToAdd) {
            const classEntry = buttonElement.closest('.class-entry');
            const classId = classEntry.getAttribute('data-id');
            const scoreElement = classEntry.querySelector('.class-score');
            let currentScore = parseInt(scoreElement.textContent) || 0;
            let newScore = currentScore + pointsToAdd;

            if (newScore < 0) {
                newScore = 0;
            }

            // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("classes") ì‚¬ìš© ***
            db.collection("classes").doc(classId).update({
                score: newScore
            });
        }

        // 'í•™ê¸‰ ìˆ˜ì •' ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
        function openEditModal(buttonElement) {
            classToEdit = buttonElement.closest('.class-entry');
            const currentName = classToEdit.querySelector('.class-name').textContent;
            
            document.getElementById('edit-name-input').value = currentName;
            document.getElementById('edit-modal-bg').style.display = 'flex';
            document.getElementById('edit-name-input').focus();
        }

        // 'í•™ê¸‰ ìˆ˜ì •' ëª¨ë‹¬ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideEditModal() {
            document.getElementById('edit-modal-bg').style.display = 'none';
            classToEdit = null;
        }

        // 'í•™ê¸‰ ìˆ˜ì •' íŒì—…ì—ì„œ 'í™•ì¸' ëˆŒë €ì„ ë•Œ
        function confirmEdit() {
            const newNameInput = document.getElementById('edit-name-input');
            const newName = newNameInput.value.trim();
            
            if (classToEdit && newName) {
                const classId = classToEdit.getAttribute('data-id');
                // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("classes") ì‚¬ìš© ***
                db.collection("classes").doc(classId).update({
                    name: newName
                });
            }
            hideEditModal();
        }

        // 'í•™ê¸‰ ìˆ˜ì •' íŒì—…ì—ì„œ 'ì‚­ì œ' ëˆŒë €ì„ ë•Œ
        function triggerDeleteFromEdit() {
            classToDelete = classToEdit;
            hideEditModal(); 
            
            document.getElementById('modal-error').textContent = '';
            document.getElementById('password-input').value = '';
            document.getElementById('delete-modal-bg').style.display = 'flex';
            document.getElementById('password-input').focus();
        }

        // ëª¨ë‹¬ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideModal() {
            document.getElementById('delete-modal-bg').style.display = 'none';
            classToDelete = null;
        }

        // ì‚­ì œ ìŠ¹ì¸ í•¨ìˆ˜
        function confirmDelete() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('modal-error');
            
            if (password === '20230301') { // ë¹„ë°€ë²ˆí˜¸
                if (classToDelete) {
                    const classId = classToDelete.getAttribute('data-id');
                    // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("classes") ì‚¬ìš© ***
                    db.collection("classes").doc(classId).delete();
                }
                hideModal();
            } else {
                errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }


        // ìˆœìœ„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateRankings() {
            const allClasses = [];
            
            document.querySelectorAll('.class-entry').forEach(entry => {
                const classNameElement = entry.querySelector('.class-name');
                const scoreElement = entry.querySelector('.class-score');
                const gradeCard = entry.closest('.grade-card');
                const gradeName = gradeCard.querySelector('h3').textContent;
                
                const className = classNameElement.textContent;
                const score = parseInt(scoreElement.textContent) || 0;
                
                allClasses.push({ name: className, score: score, grade: gradeName });
            });
            
            allClasses.sort((a, b) => b.score - a.score);
            
            const rankElements = [
                { id: 1, classEl: 'rank-1-class', scoreEl: 'rank-1-score' },
                { id: 2, classEl: 'rank-2-class', scoreEl: 'rank-2-score' },
                { id: 3, classEl: 'rank-3-class', scoreEl: 'rank-3-score' }
            ];
            
            rankElements.forEach((rank, index) => {
                const classEl = document.getElementById(rank.classEl);
                const scoreEl = document.getElementById(rank.scoreEl);
                
                const data = allClasses[index];
                
                if (data) {
                    classEl.textContent = `${data.grade} ${data.name}`;
                    scoreEl.textContent = `${data.score}ì `;
                } else {
                    classEl.textContent = '---';
                    scoreEl.textContent = `0ì `;
                }
            });
        }
        
        // ê´€ë¦¬ì ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ì—´ê¸°
        function openAdminPassModal() {
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-pass-error').textContent = '';
            document.getElementById('admin-pass-modal-bg').style.display = 'flex';
            document.getElementById('admin-password-input').focus();
        }

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°
        function hideAdminPassModal() {
            document.getElementById('admin-pass-modal-bg').style.display = 'none';
        }

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        function checkAdminPassword() {
            const password = document.getElementById('admin-password-input').value;
            const errorEl = document.getElementById('admin-pass-error');
            
            if (password === '20230301') {
                hideAdminPassModal();
                openAdminSettingsModal();
            } else {
                errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                document.getElementById('admin-password-input').value = '';
                document.getElementById('admin-password-input').focus();
            }
        }

        // ê´€ë¦¬ì ì„¤ì • ëª¨ë‹¬ ì—´ê¸° (ë¹„ë°€ë²ˆí˜¸ ì„±ê³µ í›„)
        function openAdminSettingsModal() {
            document.getElementById('title-input').value = document.getElementById('main-title').textContent.trim();
            document.getElementById('subtitle-input').value = document.getElementById('main-subtitle').textContent.trim();
            populateThresholdInputs();

            document.getElementById('admin-settings-modal-bg').style.display = 'flex';
        }

        // ê´€ë¦¬ì ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
        function hideAdminSettingsModal() {
            document.getElementById('admin-settings-modal-bg').style.display = 'none';
        }

        // ê´€ë¦¬ì ì„¤ì • ì €ì¥
        function saveAdminSettings() {
            const newTitle = document.getElementById('title-input').value.trim();
            const newSubtitle = document.getElementById('subtitle-input').value.trim();
            const thresholdsInput = {
                seed: 0,
                sprout: parseInt(document.getElementById('threshold-sprout').value, 10),
                stem: parseInt(document.getElementById('threshold-stem').value, 10),
                tree: parseInt(document.getElementById('threshold-tree').value, 10),
                flower: parseInt(document.getElementById('threshold-flower').value, 10)
            };
            growthThresholds = sanitizeThresholds(thresholdsInput);

            // *** ìˆ˜ì •: ì›ë˜ ì»¬ë ‰ì…˜ ê²½ë¡œ("settings") ì‚¬ìš© ***
            db.collection("settings").doc("main").set({
                title: newTitle,
                subtitle: newSubtitle,
                thresholds: growthThresholds
            }, { merge: true });

            applyGrowthEmojis();
            hideAdminSettingsModal();
        }
    </script>

</body>
</html>
